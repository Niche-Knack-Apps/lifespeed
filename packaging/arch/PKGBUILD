# Maintainer: Niche-Knack Apps <support@niche-knack.com>
pkgname=lifespeed
pkgver=1.0.0
pkgrel=1
pkgdesc="Blazing-fast mobile-first journaling app, offline-first with markdown and fuzzy search"
arch=('x86_64')
url="https://github.com/niche-knack/lifespeed"
license=('MIT')
depends=(
    'webkit2gtk-4.1'
    'gtk3'
    'cairo'
    'pango'
    'gdk-pixbuf2'
    'libappindicator-gtk3'
    'librsvg'
)
makedepends=(
    'rust'
    'cargo'
    'nodejs'
    'npm'
    'pkg-config'
    'openssl'
)
provides=('lifespeed')
conflicts=('lifespeed-bin' 'lifespeed-git')
source=(
    "$pkgname-$pkgver.tar.gz::https://github.com/niche-knack/lifespeed/archive/v$pkgver.tar.gz"
)
sha256sums=('SKIP')

build() {
    cd "$srcdir/$pkgname-$pkgver"
    npm ci
    npm run bundle:prod
    cd src-tauri
    cargo build --release
}

package() {
    cd "$srcdir/$pkgname-$pkgver"

    install -Dm755 "src-tauri/target/release/$pkgname" \
        "$pkgdir/usr/bin/$pkgname"

    install -Dm644 /dev/stdin "$pkgdir/usr/share/applications/$pkgname.desktop" << EOF
[Desktop Entry]
Name=Lifespeed
Comment=Fast journaling app with markdown and fuzzy search
Exec=lifespeed %F
Icon=lifespeed
Terminal=false
Type=Application
Categories=Office;
Keywords=journal;diary;markdown;notes;writing;
EOF

    for size in 32 128 256; do
        if [[ -f "src-tauri/icons/${size}x${size}.png" ]]; then
            install -Dm644 "src-tauri/icons/${size}x${size}.png" \
                "$pkgdir/usr/share/icons/hicolor/${size}x${size}/apps/$pkgname.png"
        fi
    done
    if [[ -f "src-tauri/icons/icon.png" ]]; then
        install -Dm644 "src-tauri/icons/icon.png" \
            "$pkgdir/usr/share/icons/hicolor/512x512/apps/$pkgname.png"
    fi

    install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE" 2>/dev/null || true
}
